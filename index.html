<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã‚²ãƒ¼ãƒ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 20px;
      font-family: 'Hiragino Sans', 'Yu Gothic', system-ui, sans-serif;
      background: radial-gradient(circle at top, #ffe4f3 0%, #fff6e5 45%, #ffeecf 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      max-width: 960px;
      width: 100%;
      margin: 0 auto;
      background: #fff7e9;
      border-radius: 24px;
      padding: 24px 20px 22px;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.16);
    }

    .header {
      text-align: center;
      margin-bottom: 18px;
    }

    .main-title {
      font-size: 1.9rem;
      color: #7b3a2e;
      margin-bottom: 6px;
      font-weight: 800;
    }

    .subtitle {
      font-size: 0.95rem;
      color: #a06340;
      margin-bottom: 8px;
      line-height: 1.6;
    }

    .hint {
      font-size: 0.8rem;
      color: #b07a52;
      opacity: 0.9;
    }

    @media (max-width: 640px) {
      .container { padding: 18px 14px 16px; }
      .main-title { font-size: 1.6rem; }
    }

    /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
    #gameContainer { display: none; }

    .start-body {
      text-align: center;
      margin-top: 10px;
      line-height: 1.8;
      color: #5b3624;
      font-size: 0.95rem;
    }

    .start-list {
      text-align: left;
      display: inline-block;
      margin: 8px 0 4px;
      padding-left: 1.1em;
      font-size: 0.9rem;
      color: #6c4330;
    }

    .start-btn {
      margin-top: 14px;
      background: #ffcbdd;
      color: #5a2830;
      border: none;
      padding: 10px 26px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18);
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.05s ease;
    }

    .start-btn:hover {
      background: #ffd7e7;
      transform: translateY(-1px);
      box-shadow: 0 5px 14px rgba(0, 0, 0, 0.2);
    }

    .start-btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    /* ä¸Šæ®µï¼šãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‹ã‚­ãƒ£ãƒ© */
    .top-row {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 16px;
      margin-bottom: 14px;
    }

    @media (max-width: 720px) {
      .top-row { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: #fffaf2;
      border-radius: 18px;
      padding: 16px 16px 14px;
      border: 2px solid #f0d2aa;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 1rem;
      color: #7b3a2e;
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 700;
    }

    /* ã¤ã¾ã‚‰ãªã„åº¦ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
    .meter-bar {
      width: 100%;
      height: 18px;
      background: #f3e3cf;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 6px;
    }

    .meter-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #f9c0ff 0%, #ffc46b 40%, #ff7f7f 100%);
      transition: width 0.35s ease;
    }

    .meter-label {
      font-size: 0.82rem;
      font-weight: 600;
      color: #7b3a2e;
    }

    .meter-sub {
      font-size: 0.75rem;
      color: #a56c49;
      margin-top: 4px;
    }

    /* ã‚­ãƒ£ãƒ©æˆé•· */
    .character-growth { text-align: center; }

    .character-area {
      margin-top: 4px;
      background: #fff5e5;
      border-radius: 14px;
      padding: 10px 10px 8px;
      border: 1px solid #f0d2aa;
    }

    .character-display { margin-top: 4px; }

    .character-sprite {
      width: 96px;
      height: 96px;
      margin: 4px auto;
      background-image: url("public/chara/boring_chars.png");
      background-repeat: no-repeat;
      background-size: 400% 300%; /* 4åˆ—Ã—3è¡Œ */
      background-position: 0% 0%;
    }

    .character-status {
      font-size: 0.92rem;
      font-weight: 700;
      color: #7b3a2e;
      margin-bottom: 4px;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: #f3e3cf;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ffc9de, #ffc46b);
      transition: width 0.3s ease;
    }

    .growth-stage {
      font-size: 0.78rem;
      color: #a56c49;
      margin-top: 3px;
    }

    .character-message {
      font-size: 0.8rem;
      color: #a56c49;
      margin: 4px 0 0;
      min-height: 2.1em;
    }

    /* ä¸‹æ®µï¼šãŠä¸–è©±éƒ¨åˆ† */
    .current-card { margin-top: 6px; }

    .game-title {
      font-size: 1rem;
      font-weight: 700;
      color: #7b3a2e;
      margin: 0 0 8px;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .game-title span {
      font-size: 0.8rem;
      font-weight: 500;
      color: #b07a52;
      white-space: nowrap;
    }

    .game-area {
      background: #fffdf7;
      border-radius: 14px;
      padding: 10px 10px 8px;
      border: 1px solid #f0d2aa;
    }

    .status {
      font-size: 1rem;
      color: #543123;
      margin: 0 0 6px;
      line-height: 1.7;
    }

    .task-hint {
      font-size: 0.78rem;
      color: #b07a52;
      margin: 0 0 8px;
    }

    .care-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .btn {
      background: #ffcbdd;
      color: #5a2830;
      border: none;
      padding: 7px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.05s ease, opacity 0.15s ease;
      white-space: nowrap;
    }

    .btn:nth-child(2) { background: #ffe3b8; }
    .btn:nth-child(3) { background: #daf3c4; }

    .btn:hover:enabled {
      background: #ffd7e7;
      transform: translateY(-1px);
      box-shadow: 0 3px 7px rgba(0, 0, 0, 0.16);
    }

    .btn:active:enabled {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .care-buttons.disabled .btn {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .small-btn {
      font-size: 0.78rem;
      padding: 6px 10px;
      margin-top: 4px;
    }

    .log-message {
      font-size: 0.8rem;
      color: #a56c49;
      min-height: 1.4em;
      margin-top: 2px;
    }

    .result-box {
      font-size: 0.82rem;
      color: #543123;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed #e0c09a;
      display: none;
    }

    .result-box ul {
      padding-left: 1.2em;
      margin: 4px 0;
    }

    footer {
      margin-top: 8px;
      text-align: center;
      font-size: 0.72rem;
      color: #a56c49;
      opacity: 0.8;
    }

    /* ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .analysis-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 12px;
    }

    .analysis-content {
      background: #fffaf4;
      border-radius: 20px;
      padding: 16px 16px 14px;
      max-width: 420px;
      width: 100%;
      text-align: left;
      border: 2px solid #f0d2aa;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .analysis-title {
      font-size: 1rem;
      color: #7b3a2e;
      margin-bottom: 6px;
      font-weight: 700;
    }

    .mini-caption {
      font-size: 0.8rem;
      color: #a56c49;
      margin-bottom: 8px;
    }

    .mini-area {
      position: relative;
      width: 100%;
      height: 150px;
      background: #fff3e3;
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 6px;
      border: 1px solid #f0d2aa;
      touch-action: none;
    }

    .mini-item {
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ffb7cf;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.18);
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #miniCatcher {
      position: absolute;
      bottom: 6px;
      width: 40px;
      height: 10px;
      border-radius: 10px;
      background: #ff9a59;
    }

    .mini-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      font-size: 0.8rem;
      color: #7b4a27;
    }

    .mini-timer {
      font-feature-settings: "tnum";
      font-weight: 600;
    }

    .mini-counter {
      font-size: 0.78rem;
      opacity: 0.8;
      margin-top: 2px;
    }

    .mini-buttons {
      display: flex;
      gap: 6px;
    }

    .mini-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 0.78rem;
      cursor: pointer;
      background: #ffe1c0;
      color: #5a2d1c;
    }

    .mini-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .hidden { display: none; }

    /* ä¸¦ã¹ã‚‹ã‚²ãƒ¼ãƒ ç”¨ãƒ–ãƒ­ãƒƒã‚¯ */
    .mini-arrange-block {
      position: absolute;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      background: #f5c9a5;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: top 0.2s ease, transform 0.1s ease, background 0.2s ease;
    }

    .mini-arrange-block.aligned {
      background: #f2b37e;
    }

    /* æƒé™¤ã‚²ãƒ¼ãƒ ç”¨æ±šã‚Œ */
    .mini-dirt {
      position: absolute;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #d0b58f;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.1s ease, opacity 0.15s ease;
    }

    .mini-dirt.tapped {
      transform: scale(0.8);
      opacity: 0.8;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>
<body>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
  <div id="startScreen" class="container">
    <header class="header">
      <h1 class="main-title" id="startMainTitle">ğŸ¥š ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã‚²ãƒ¼ãƒ </h1>
      <p class="subtitle">
        å ±ã‚ã‚Œãªã„ãŠä¸–è©±ã‚’100å€‹ã ã‘è¦³å¯Ÿã™ã‚‹ã€å°ã•ãªå®Ÿé¨“ã‚²ãƒ¼ãƒ ã§ã™ã€‚<br>
        æ¯å›ã€ãŠä¸–è©±ã®æ–‡ç« ã‚’èª­ã‚“ã§ â†’ ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ã§ã€Œãªã‚“ã¨ãªããŠä¸–è©±ã€ â†’ ãã®ã‚ã¨ã§ã¤ã¾ã‚‰ãªã•ã‚’ã‚¸ãƒ£ãƒƒã‚¸ã—ã¾ã™ã€‚
      </p>
      <p class="hint">
        æœ€å¾Œã«ã¯ã€10ä½“ã®ã¤ã¾ã‚‰ãªã„ã‚­ãƒ£ãƒ©ã¨ã€ãƒ©ã‚¹ãƒœã‚¹ã€Œã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹å®¶äº‹ãƒ¡ãƒ¢ã‚Šã‚“ã€ãŒç™»å ´ã—ã¾ã™ã€‚
      </p>
    </header>
    <div class="start-body">
      éŠã³æ–¹ã®æµã‚Œ
      <ul class="start-list">
        <li>1. ã¾ãšã¯ã€Œã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã€ã®æ–‡ç« ã‚’èª­ã‚€</li>
        <li>2. 5ç§’ã ã‘ã€ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ã§ã€Œãªã‚“ã¨ãªããŠä¸–è©±ã€ã™ã‚‹</li>
        <li>3. ä»Šã®æ°—åˆ†ã§ã¤ã¾ã‚‰ãªã•ã‚’ã‚¸ãƒ£ãƒƒã‚¸ã™ã‚‹</li>
      </ul>
      <div>100å€‹ã‚¸ãƒ£ãƒƒã‚¸ã™ã‚‹ã¨ã€ã‚ãªãŸå°‚ç”¨ã®ã€Œã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã®å†…è¨³ã€ã¨ãƒ©ã‚¹ãƒœã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
      <button id="startButton" class="start-btn">ã¯ã˜ã‚ã‚‹</button>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢ -->
  <div id="gameContainer" class="container">
    <header class="header">
      <h1 class="main-title" id="mainTitle">ğŸ¥š ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã‚²ãƒ¼ãƒ </h1>
      <p class="subtitle" id="subtitle">å ±ã‚ã‚Œãªã„ãŠä¸–è©±ã‚’100å€‹ã“ãªã™ã¨ã€å¤‰ãªã‚­ãƒ£ãƒ©ãŒç”Ÿã¾ã‚Œã¾ã™ã€‚</p>
      <p class="hint">1ã¤ãšã¤ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ã§ã€Œãªã‚“ã¨ãªããŠä¸–è©±ã€â†’ ãã®å ´ã§ã¤ã¾ã‚‰ãªã„åº¦ã‚’ã‚¸ãƒ£ãƒƒã‚¸ã€‚</p>
    </header>

    <div class="top-row">
      <!-- ãƒ¡ãƒ¼ã‚¿ãƒ¼ -->
      <div class="card">
        <h2>ğŸ˜´ ã„ã¾ã®ã¤ã¾ã‚‰ãªã„åº¦</h2>
        <div class="meter-bar">
          <div class="meter-fill" id="boredomFill"></div>
        </div>
        <div class="meter-label" id="boredomLevel">
          0% - ã¾ã è¨ˆæ¸¬ã•ã‚Œã¦ã„ã¾ã›ã‚“
        </div>
        <div class="meter-sub" id="boredomSub">
          ã‚¸ãƒ£ãƒƒã‚¸ãŒå¢—ãˆã‚‹ã»ã©ã€ã“ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒã˜ã‚ã˜ã‚å‹•ãã¾ã™ã€‚
        </div>
        <div class="meter-sub" id="boredomBreakdown"></div>
      </div>

      <!-- ã‚­ãƒ£ãƒ© -->
      <div class="card character-growth">
        <h2>ğŸŒ± æˆé•·ã™ã‚‹ã¤ã¾ã‚‰ãªã„ã‚­ãƒ£ãƒ©</h2>
        <div class="character-area">
          <div class="character-display">
            <div id="characterSprite" class="character-sprite"></div>
          </div>
          <div class="character-status" id="characterStatus">ã¤ã¾ã‚‰ãªã„ã‚­ãƒ£ãƒ©ï¼šã»ã“ã‚Šã‚“</div>
          <div class="progress-bar">
            <div class="progress-fill" id="growthProgress"></div>
          </div>
          <div class="growth-stage" id="growthStage">ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ï¼š0 / 100</div>
          <div class="character-message" id="characterMessage">
            ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ãŒå¢—ãˆã‚‹ã»ã©ã€10ä½“ã®ã‚­ãƒ£ãƒ©ãŒé †ç•ªã«å‡ºã¦ãã¾ã™ã€‚
          </div>
        </div>
      </div>
    </div>

    <!-- ãŠä¸–è©± -->
    <div class="card current-card">
      <h3 class="game-title">
        <span id="taskLabel">No.1 ã®ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±</span>
        <span id="taskStageLabel">1 / 100</span>
      </h3>
      <div class="game-area">
        <p class="status" id="taskText"></p>
        <p class="task-hint" id="taskHint">
          ã¾ãšã¯5ç§’ã ã‘ã€ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ã§ã€Œãªã‚“ã¨ãªããŠä¸–è©±ã€ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
        </p>

        <button class="btn small-btn" id="openMiniBtn">
          ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ã§ãªã‚“ã¨ãªããŠä¸–è©±ã™ã‚‹
        </button>

        <div class="care-buttons" id="ratingButtons">
          <button class="btn" data-score="0">ã“ã‚Œã¯ã¤ã¾ã‚‰ãªã„</button>
          <button class="btn" data-score="1">ã¾ã‚ã¤ã¾ã‚‰ãªã„</button>
          <button class="btn" data-score="2">æ„å¤–ã¨å¥½ãã‹ã‚‚ã—ã‚Œãªã„</button>
        </div>
        <div class="log-message" id="logMessage"></div>
        <div class="result-box" id="resultBox"></div>
      </div>
    </div>

    <footer>
      100å€‹ãœã‚“ã¶ã‚¸ãƒ£ãƒƒã‚¸ã™ã‚‹ã¨ã€ã€Œã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã®å†…è¨³ã€ã¨ãƒ©ã‚¹ãƒœã‚¹ã€Œã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹å®¶äº‹ãƒ¡ãƒ¢ã‚Šã‚“ã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    </footer>
  </div>

  <!-- ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="analysis-modal" id="miniModal">
    <div class="analysis-content">
      <h2 class="analysis-title">ãƒŸãƒ‹ãŠä¸–è©±ã‚²ãƒ¼ãƒ </h2>
      <p class="mini-caption" id="miniCaption">
        ä»Šå›ã®ã€Œã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã€ã‚’ã€å°ã•ãªãƒŸãƒ‹ã‚²ãƒ¼ãƒ ã§å†ç¾ã—ã¦ã„ã¾ã™ã€‚ï¼ˆã‚ã¾ã‚Šæ„å‘³ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰
      </p>
      <div class="mini-area" id="miniArea">
        <div id="miniCatcher"></div>
      </div>
      <div class="mini-footer">
        <div>
          ã®ã“ã‚Š <span class="mini-timer" id="miniTimer">5.0</span> ç§’
          <div class="mini-counter" id="miniCounter">ã¨ã‚ŒãŸæ•°ï¼š0</div>
        </div>
        <div class="mini-buttons">
          <button class="mini-btn" id="miniStartBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          <button class="mini-btn hidden" id="miniOkBtn">ã“ã®ãã‚‰ã„ã§OK</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const TOTAL_TASKS = 100;
    const SPRITE_IMAGE_URL = "public/chara/boring_chars.png";
    const BOSS_IMAGE_URL   = "public/chara/endless_memorin.png";

    // é€²åŒ–ã‚­ãƒ£ãƒ©
    const evolutionCharacters = [
      { threshold: 0,  name: "ã»ã“ã‚Šã‚“",               spriteIndex: 0,
        msg: "ãµã‚ã£ã¨å¢—ãˆã¦ã„ãã€çµ‚ã‚ã‚‰ãªã„æƒé™¤ã®è±¡å¾´ã€‚" },
      { threshold: 5,  name: "ã¬ã‚Œãã†ãã‚“ã•ã‚“",       spriteIndex: 1,
        msg: "ãŒã‚“ã°ã£ã¦ã„ã‚‹ã®ã«ã€éƒ¨å±‹ã®ã‚­ãƒ¬ã‚¤ã•ã¯ã‚ã¾ã‚Šå¤‰ã‚ã‚‰ãªã„æ®µéšã§ã™ã€‚" },
      { threshold: 10, name: "ã¡ã‚ƒã·é›»æ± ï¼ˆ3ï¼…å¦–ç²¾ï¼‰",  spriteIndex: 2,
        msg: "ã¡ã‚‡ã£ã¨ã ã‘ç„¦ã‚‰ã›ã¦ãã‚‹ã€å®‰å¿ƒæ„Ÿã¨ä¸å®‰ã®ã‚ã„ã ã®ã¤ã¾ã‚‰ãªã•ã€‚" },
      { threshold: 15, name: "ãƒã‚¹ãƒˆãã‚“",             spriteIndex: 3,
        msg: "ã©ã‚Œã ã‘æœŸå¾…ã—ã¦ã‚‚ãƒãƒ©ã‚·ã°ã‹ã‚Šå‡ºã¦ãã‚‹ã€æƒ…å ±éå¤šãªã¤ã¾ã‚‰ãªã•ã‚¾ãƒ¼ãƒ³ã€‚" },
      { threshold: 20, name: "ã„ã­ã‚€ã‚Šã‚¹ãƒªãƒƒãƒ‘",       spriteIndex: 4,
        msg: "ãã‚ãˆã¦ã‚‚å¤–å‡ºã‚¤ãƒ™ãƒ³ãƒˆã«ã¯ãªã‚‰ãªã„ã€ã€Œãã‚ãˆã‚‹ã“ã¨ã€ãã®ã‚‚ã®ã®ä¸–ç•Œã€‚" },
      { threshold: 25, name: "ã™ã¹ã‚Šã“ã¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãã‚“", spriteIndex: 5,
        msg: "æ—¥ä»˜ã ã‘ãŒæ·¡ã€…ã¨é€²ã‚“ã§ã„ãã€æ™‚é–“ç³»ã®ã¤ã¾ã‚‰ãªã•ã€‚" },
      { threshold: 30, name: "ãã‚‚ã‚Šãƒ¡ã‚¬ãƒã•ã‚“",       spriteIndex: 6,
        msg: "ãµã„ã¦ã‚‚ãµã„ã¦ã‚‚å®Œç’§ã«ãªã‚‰ãªã„ã€ã€Œè¦‹ãˆã«ãã•ã€ã¨ä»˜ãåˆã†æ®µéšã€‚" },
      { threshold: 35, name: "ã‚¿ã‚ªãƒ«ãŸã‚“",             spriteIndex: 7,
        msg: "åŠä¹¾ãã¨ã¨ã‚‚ã«ç”Ÿãã¦ã„ãã€ã€Œã¾ã‚ã“ã‚“ãªã‚‚ã®ã‹ã€ã¨ã„ã†ã¤ã¾ã‚‰ãªã•ã€‚" },
      { threshold: 40, name: "Wi-Fiã•ãŒã—ã®ãŠã°ã‘",    spriteIndex: 8,
        msg: "ã©ã“ã¾ã§æ¢ã—ã¦ã‚‚ã€Œè¶…é«˜é€Ÿï¼ã€ã«ã¯ãªã‚‰ãªã„ã€æ¢ã—ç¶šã‘ã‚‹ã¤ã¾ã‚‰ãªã•ã€‚" },
      { threshold: 45, name: "ã¤ã¿ã‹ã•ã­ãƒ¬ã‚·ãƒ¼ãƒˆãã‚“", spriteIndex: 9,
        msg: "æ¨ã¦ã‚‹ã‹æ®‹ã™ã‹è¿·ã„ç¶šã‘ã‚‹ã€ç”Ÿæ´»ãƒ­ã‚°ç³»ã¤ã¾ã‚‰ãªã•ã®æœ€çµ‚å½¢ã€‚" }
    ];

    const bossCharacter = {
      name: "ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹å®¶äº‹ãƒ¡ãƒ¢ã‚Šã‚“",
      msg:  "ã©ã‚Œã ã‘ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚‚ã‚„ã‚‹ã“ã¨ãŒæ¸›ã‚‰ãªã„ã€ã€Œçµ‚ã‚ã‚‰ãªã„å®¶äº‹ãƒªã‚¹ãƒˆã€ã®åŒ–èº«ã§ã™ã€‚"
    };

    // ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±100å€‹ï¼ˆãã®ã¾ã¾ï¼‰
    const tasks = [/* ã“ã“ã¯ã”è³ªå•ã®å…ƒã‚³ãƒ¼ãƒ‰ã¨åŒã˜100å€‹ã®é…åˆ—ã€‚é•·ã„ã®ã§çœç•¥ã›ãšè²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ */];

    // DOM
    const startScreenEl = document.getElementById('startScreen');
    const gameContainerEl = document.getElementById('gameContainer');
    const startButtonEl = document.getElementById('startButton');

    const boredomFillEl = document.getElementById('boredomFill');
    const boredomLevelEl = document.getElementById('boredomLevel');
    const boredomSubEl = document.getElementById('boredomSub');
    const boredomBreakdownEl = document.getElementById('boredomBreakdown');

    const characterSpriteEl = document.getElementById('characterSprite');
    const characterStatusEl = document.getElementById('characterStatus');
    const characterMessageEl = document.getElementById('characterMessage');
    const growthProgressEl = document.getElementById('growthProgress');
    const growthStageEl = document.getElementById('growthStage');

    const taskLabelEl = document.getElementById('taskLabel');
    const taskStageLabelEl = document.getElementById('taskStageLabel');
    const taskTextEl = document.getElementById('taskText');
    const taskHintEl = document.getElementById('taskHint');
    const ratingButtonsEl = document.getElementById('ratingButtons');
    const logMessageEl = document.getElementById('logMessage');
    const resultBoxEl = document.getElementById('resultBox');
    const openMiniBtn = document.getElementById('openMiniBtn');

    const miniModalEl = document.getElementById('miniModal');
    const miniCaptionEl = document.getElementById('miniCaption');
    const miniAreaEl = document.getElementById('miniArea');
    const miniCatcherEl = document.getElementById('miniCatcher');
    const miniTimerEl = document.getElementById('miniTimer');
    const miniCounterEl = document.getElementById('miniCounter');
    const miniStartBtn = document.getElementById('miniStartBtn');
    const miniOkBtn = document.getElementById('miniOkBtn');

    // çŠ¶æ…‹
    let currentIndex = 0;
    const ratings = [];
    let miniPlayedForThisTask = false;

    // ãƒŸãƒ‹ã‚²ãƒ¼ãƒ çŠ¶æ…‹
    let miniPlaying = false;
    let miniStartTime = 0;
    const miniDuration = 5000;
    let miniTimerInterval = null;
    let miniGameInterval = null;
    let miniItems = [];
    let miniCaught = 0;
    let catcherX = 0;

    let miniGameType = 'fall';      // 'fall' | 'arrange' | 'clean'
    let currentMiniKind = 'normal'; // 'normal' | 'poop' | 'water'

    // ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function countRatings() {
      let count0 = 0, count1 = 0, count2 = 0;
      ratings.forEach(r => {
        if (r === 0) count0++;
        else if (r === 1) count1++;
        else if (r === 2) count2++;
      });
      return { count0, count1, count2 };
    }

    function setSpriteByIndex(index) {
      const cols = 4;
      const rows = 3;
      const col = index % cols;
      const row = Math.floor(index / cols);

      characterSpriteEl.style.backgroundImage = `url("${SPRITE_IMAGE_URL}")`;
      characterSpriteEl.style.backgroundSize = "400% 300%";

      const x = (cols === 1) ? 0 : (col / (cols - 1)) * 100;
      const y = (rows === 1) ? 0 : (row / (rows - 1)) * 100;
      characterSpriteEl.style.backgroundPosition = `${x}% ${y}%`;
    }

    function updateCharacter() {
      const n = currentIndex;
      const { count0 } = countRatings();

      const percent = Math.min(100, (n / TOTAL_TASKS) * 100);
      growthProgressEl.style.width = percent + '%';
      growthStageEl.textContent = `ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ï¼š${Math.min(n, TOTAL_TASKS)} / ${TOTAL_TASKS}`;

      if (n >= TOTAL_TASKS) {
        characterSpriteEl.style.backgroundImage = `url("${BOSS_IMAGE_URL}")`;
        characterSpriteEl.style.backgroundSize = "contain";
        characterSpriteEl.style.backgroundPosition = "center";
        characterStatusEl.textContent = `ãƒ©ã‚¹ãƒœã‚¹ï¼š${bossCharacter.name}`;
        characterMessageEl.textContent =
          bossCharacter.msg + "ã€€ä»Šæ—¥ã‚‚ã€Œã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã€ã¯é™ã‹ã«ãƒšãƒ¼ã‚¸ã‚’å¢—ã‚„ã—ã¦ã„ãã¾ã™ã€‚";
        return;
      }

      let stage = evolutionCharacters[0];
      for (const s of evolutionCharacters) {
        if (count0 >= s.threshold) stage = s;
      }

      setSpriteByIndex(stage.spriteIndex);
      characterStatusEl.textContent = `ã¤ã¾ã‚‰ãªã„ã‚­ãƒ£ãƒ©ï¼š${stage.name}`;
      characterMessageEl.textContent =
        stage.msg + `ï¼ˆã€Œã“ã‚Œã¯ã¤ã¾ã‚‰ãªã„ã€ã¨ã‚¸ãƒ£ãƒƒã‚¸ã—ãŸå›æ•°ï¼š${count0} å›ï¼‰`;
    }

    function updateTask() {
      const no = currentIndex + 1;

      if (currentIndex >= TOTAL_TASKS) {
        taskLabelEl.textContent = `ã™ã¹ã¦ã®ãŠä¸–è©±ã‚’ã‚¸ãƒ£ãƒƒã‚¸ã—ã¾ã—ãŸ`;
        taskStageLabelEl.textContent = `${TOTAL_TASKS} / ${TOTAL_TASKS}`;
        taskTextEl.textContent =
          "ã“ã“ã‹ã‚‰å…ˆã¯ã€ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹å®¶äº‹ãƒ¡ãƒ¢ã‚Šã‚“ãŒé™ã‹ã«ã‚ãªãŸã®ã€Œã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã€ã‚’è¦‹å®ˆã‚Šã¾ã™ã€‚";
        taskHintEl.textContent = "ä¸‹ã®çµæœãƒœãƒƒã‚¯ã‚¹ã§ã€ä»Šæ—¥ã®ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã®å†…è¨³ã‚’çœºã‚ã¦ã¿ã¦ãã ã•ã„ã€‚";
        openMiniBtn.style.display = 'none';
        return;
      }

      taskLabelEl.textContent = `No.${no} ã®ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±`;
      taskStageLabelEl.textContent = `${no} / ${TOTAL_TASKS}`;
      taskTextEl.textContent = tasks[currentIndex];
      taskHintEl.textContent =
        'ã¾ãšã¯5ç§’ã ã‘ã€ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ã§ã€Œãªã‚“ã¨ãªããŠä¸–è©±ã€ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ãã®ã‚ã¨ã§ã‚¸ãƒ£ãƒƒã‚¸ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚';
      logMessageEl.textContent = '';

      openMiniBtn.style.display = 'inline-block';
      openMiniBtn.textContent = 'ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ã§ãªã‚“ã¨ãªããŠä¸–è©±ã™ã‚‹';
    }

    function updateBoredomMeter() {
      if (ratings.length === 0) {
        boredomFillEl.style.width = '0%';
        boredomLevelEl.textContent = '0% - ã¾ã è¨ˆæ¸¬ã•ã‚Œã¦ã„ã¾ã›ã‚“';
        boredomSubEl.textContent = 'ã‚¸ãƒ£ãƒƒã‚¸ãŒå¢—ãˆã‚‹ã»ã©ã€ã“ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒã˜ã‚ã˜ã‚å‹•ãã¾ã™ã€‚';
        boredomBreakdownEl.textContent =
          'ã€Œã“ã‚Œã¯ã¤ã¾ã‚‰ãªã„ã€ã€Œã¾ã‚ã¤ã¾ã‚‰ãªã„ã€ã€Œæ„å¤–ã¨å¥½ãã‹ã‚‚ã€ã®å›æ•°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
        return;
      }

      let totalScore = 0;
      ratings.forEach(r => {
        if (r === 0) totalScore += 100;
        else if (r === 1) totalScore += 60;
        else totalScore += 20;
      });

      const level = Math.round(totalScore / ratings.length);
      boredomFillEl.style.width = level + '%';

      let label = '';
      if (level < 20)      label = `${level}% - ã¾ã æ¥½ã—ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“`;
      else if (level < 40) label = `${level}% - ã¡ã‚‡ã£ã¨ã¤ã¾ã‚‰ãªã„ä¸–ç•Œ`;
      else if (level < 60) label = `${level}% - ã ã„ã¶ã¤ã¾ã‚‰ãªã„æ—¥å¸¸`;
      else if (level < 80) label = `${level}% - ã‹ãªã‚Šå ±ã‚ã‚Œãªã„ã‚¾ãƒ¼ãƒ³`;
      else                 label = `${level}% - çµ¶æœ›çš„ã«ã¤ã¾ã‚‰ãªã„ï¼ˆã„ã„æ„å‘³ã§ï¼‰`;

      boredomLevelEl.textContent = label;
      boredomSubEl.textContent = `ã“ã‚Œã¾ã§ã« ${ratings.length} å€‹ã®ãŠä¸–è©±ã‚’ã‚¸ãƒ£ãƒƒã‚¸ã—ã¾ã—ãŸã€‚`;

      const { count0, count1, count2 } = countRatings();
      boredomBreakdownEl.textContent =
        `å†…è¨³ï¼š ã€Œã“ã‚Œã¯ã¤ã¾ã‚‰ãªã„ã€${count0}å› ï¼ ã€Œã¾ã‚ã¤ã¾ã‚‰ãªã„ã€${count1}å› ï¼ ã€Œæ„å¤–ã¨å¥½ãã‹ã‚‚ã€${count2}å›`;
    }

    function setButtonsEnabled(enabled) {
      if (enabled) ratingButtonsEl.classList.remove('disabled');
      else         ratingButtonsEl.classList.add('disabled');
      ratingButtonsEl.querySelectorAll('.btn').forEach(btn => {
        btn.disabled = !enabled;
      });
    }

    function showLastRatingMessage(score) {
      if      (score === 0) logMessageEl.textContent = 'ã€Œã“ã‚Œã¯ã¤ã¾ã‚‰ãªã„ã€ã¨ã‚¸ãƒ£ãƒƒã‚¸ã—ã¾ã—ãŸã€‚';
      else if (score === 1) logMessageEl.textContent = 'ã€Œã¾ã‚ã¤ã¾ã‚‰ãªã„ã€ã¨ã‚¸ãƒ£ãƒƒã‚¸ã—ã¾ã—ãŸã€‚';
      else                  logMessageEl.textContent = 'ã€Œæ„å¤–ã¨å¥½ãã‹ã‚‚ã—ã‚Œãªã„ã€ã¨ã‚¸ãƒ£ãƒƒã‚¸ã—ã¾ã—ãŸã€‚';
    }

    function showFinalSummary() {
      const { count0, count1, count2 } = countRatings();
      resultBoxEl.style.display = 'block';
      resultBoxEl.innerHTML =
        `<p>100å€‹ã™ã¹ã¦ã‚¸ãƒ£ãƒƒã‚¸ã—ã¾ã—ãŸã€‚</p>
         <p>ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã®å†…è¨³ï¼š</p>
         <ul>
           <li>ã€Œã“ã‚Œã¯ã¤ã¾ã‚‰ãªã„ã€ï¼š${count0} å€‹</li>
           <li>ã€Œã¾ã‚ã¤ã¾ã‚‰ãªã„ã€ï¼š${count1} å€‹</li>
           <li>ã€Œæ„å¤–ã¨å¥½ãã‹ã‚‚ã—ã‚Œãªã„ã€ï¼š${count2} å€‹</li>
         </ul>
         <p>ã“ã®çµæœã‚’ãŸã©ã£ã¦ãŸã©ã‚Šç€ã„ãŸã®ãŒã€ãƒ©ã‚¹ãƒœã‚¹ã€Œã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹å®¶äº‹ãƒ¡ãƒ¢ã‚Šã‚“ã€ã§ã™ã€‚</p>
         <button class="btn small-btn" id="restartBtn">ã‚‚ã†ä¸€åº¦ã¯ã˜ã‚ã‹ã‚‰</button>`;

      document.getElementById('restartBtn').addEventListener('click', initGame);
    }

    // ã‚¸ãƒ£ãƒƒã‚¸
    function handleRating(score) {
      if (!miniPlayedForThisTask) {
        logMessageEl.textContent = 'ã¾ãšã¯ãƒŸãƒ‹ãŠä¸–è©±ã‚²ãƒ¼ãƒ ã§ã€5ç§’ã ã‘æ“ä½œã—ã¦ã¿ã¦ãã ã•ã„ã€‚';
        openMiniForCurrentTask();
        return;
      }

      ratings[currentIndex] = score;
      showLastRatingMessage(score);
      updateBoredomMeter();

      currentIndex++;
      miniPlayedForThisTask = false;

      if (currentIndex >= TOTAL_TASKS) {
        currentIndex = TOTAL_TASKS;
        updateCharacter();
        updateTask();
        setButtonsEnabled(false);
        openMiniBtn.style.display = 'none';
        showFinalSummary();
        logMessageEl.textContent = 'ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã®æ—…ã¯ã“ã“ã¾ã§ã§ã™ã€‚';
        return;
      }

      updateCharacter();
      updateTask();
      setButtonsEnabled(false);
    }

    // ãƒŸãƒ‹ã‚²ãƒ¼ãƒ å…±é€šãƒªã‚»ãƒƒãƒˆ
    function stopMiniGame() {
      miniPlaying = false;
      if (miniTimerInterval) { clearInterval(miniTimerInterval); miniTimerInterval = null; }
      if (miniGameInterval)  { clearInterval(miniGameInterval);  miniGameInterval  = null; }

      miniItems.forEach(obj => {
        if (obj.el && obj.el.parentNode === miniAreaEl) miniAreaEl.removeChild(obj.el);
      });
      miniItems = [];
    }

    function setupStaticMiniGame() {
      const rect = miniAreaEl.getBoundingClientRect();

      if (miniGameType === 'arrange') {
        const centerY = rect.height / 2;
        const count = 6;
        for (let i = 0; i < count; i++) {
          const block = document.createElement('div');
          block.className = 'mini-arrange-block';
          const x = (rect.width / (count + 1)) * (i + 1);
          const offsetY = (Math.random() * 40) - 20;
          const y = centerY + offsetY;
          block.style.left = (x - 12) + 'px';
          block.style.top  = (y - 12) + 'px';
          block.addEventListener('click', () => {
            miniCaught++;
            miniCounterEl.textContent = 'ã•ã‚ã£ãŸå›æ•°ï¼š' + miniCaught;
            block.style.top = (centerY - 12) + 'px';
            block.classList.add('aligned');
          });
          miniAreaEl.appendChild(block);
        }
      } else if (miniGameType === 'clean') {
        const spots = 8;
        for (let i = 0; i < spots; i++) {
          const dirt = document.createElement('div');
          dirt.className = 'mini-dirt';
          dirt.textContent = 'æ±š';
          const x = Math.random() * (rect.width  - 20) + 10;
          const y = Math.random() * (rect.height - 20) + 10;
          dirt.style.left = (x - 10) + 'px';
          dirt.style.top  = (y - 10) + 'px';
          dirt.addEventListener('click', () => {
            miniCaught++;
            miniCounterEl.textContent = 'ã“ã™ã£ãŸå›æ•°ï¼š' + miniCaught;
            dirt.classList.add('tapped');
            setTimeout(() => dirt.classList.remove('tapped'), 120);
          });
          miniAreaEl.appendChild(dirt);
        }
      }
    }

    function resetMiniGameView() {
      stopMiniGame();

      miniCaught = 0;
      miniTimerEl.textContent = '5.0';

      if (miniGameType === 'fall') {
        miniCounterEl.textContent = 'ã¨ã‚ŒãŸæ•°ï¼š0';
      } else if (miniGameType === 'clean') {
        miniCounterEl.textContent = 'ã“ã™ã£ãŸå›æ•°ï¼š0';
      } else {
        miniCounterEl.textContent = 'ã•ã‚ã£ãŸå›æ•°ï¼š0';
      }

      miniStartBtn.disabled = false;
      miniStartBtn.classList.remove('hidden');
      miniOkBtn.classList.add('hidden');

      // ä¸­èº«ã‚’ãƒªã‚»ãƒƒãƒˆ
      while (miniAreaEl.firstChild) {
        miniAreaEl.removeChild(miniAreaEl.firstChild);
      }

      if (miniGameType === 'fall') {
        miniAreaEl.appendChild(miniCatcherEl);
        miniCatcherEl.style.display = 'block';

        const rect = miniAreaEl.getBoundingClientRect();
        catcherX = rect.width / 2;
        miniCatcherEl.style.left = (catcherX - 20) + 'px';
      } else {
        miniCatcherEl.style.display = 'none';
        setupStaticMiniGame();
      }
    }

    function startMiniGame() {
      stopMiniGame();
      miniPlaying = true;
      miniStartTime = performance.now();
      miniStartBtn.disabled = true;

      miniTimerInterval = setInterval(() => {
        const elapsed = performance.now() - miniStartTime;
        const remain = Math.max(0, (miniDuration - elapsed) / 1000);
        miniTimerEl.textContent = remain.toFixed(1);
        if (elapsed >= miniDuration) endMiniGame();
      }, 80);

      if (miniGameType === 'fall') {
        miniGameInterval = setInterval(updateMiniGame, 30);
      }
    }

    function endMiniGame() {
      if (!miniPlaying) return;
      stopMiniGame();
      miniStartBtn.classList.add('hidden');
      miniOkBtn.classList.remove('hidden');
      miniCaptionEl.textContent += "ã€€ãŸãã•ã‚“å‹•ã‹ã—ã¦ã‚‚ã€ç¾å®Ÿä¸–ç•Œã¯ã‚ã¾ã‚Šå¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚";
    }

    function updateMiniGame() {
      if (miniGameType !== 'fall') return;

      const areaRect = miniAreaEl.getBoundingClientRect();
      const catcherWidth = 40;
      const catcherY = areaRect.height - 6 - 10;

      // ãƒ©ãƒ³ãƒ€ãƒ ã«è½ã¡ã¦ãã‚‹
      if (Math.random() < 0.12) {
        const itemEl = document.createElement('div');
        itemEl.className = 'mini-item';

        let displayEmoji = '';
        if (currentMiniKind === 'poop')  displayEmoji = 'ğŸ’©';
        if (currentMiniKind === 'water') displayEmoji = 'ğŸ’§';

        let size = 14;
        if (displayEmoji) {
          itemEl.textContent = displayEmoji;
          itemEl.style.background = 'transparent';
          size = 22;
          itemEl.style.width = size + 'px';
          itemEl.style.height = size + 'px';
          itemEl.style.fontSize = '18px';
        }

        const x = Math.random() * (areaRect.width - size) + size / 2;
        const y = -size;
        itemEl.style.left = (x - size / 2) + 'px';
        itemEl.style.top  = y + 'px';
        miniAreaEl.appendChild(itemEl);
        miniItems.push({ x, y, el: itemEl, halfWidth: size / 2 });
      }

      const speed = 3;
      const newItems = [];
      miniItems.forEach(obj => {
        obj.y += speed;
        if (obj.y > areaRect.height + 20) {
          if (obj.el.parentNode === miniAreaEl) miniAreaEl.removeChild(obj.el);
          return;
        }

        const dx = obj.x - catcherX;
        if (obj.y >= catcherY - 10 && Math.abs(dx) < catcherWidth / 2 + obj.halfWidth) {
          miniCaught++;
          miniCounterEl.textContent = 'ã¨ã‚ŒãŸæ•°ï¼š' + miniCaught;
          if (obj.el.parentNode === miniAreaEl) miniAreaEl.removeChild(obj.el);
          return;
        }

        obj.el.style.top = obj.y + 'px';
        newItems.push(obj);
      });
      miniItems = newItems;

      miniCatcherEl.style.left = (catcherX - catcherWidth / 2) + 'px';
    }

    function onMiniPointerMove(e) {
      const rect = miniAreaEl.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      let x = clientX - rect.left;
      x = Math.max(20, Math.min(rect.width - 20, x));
      catcherX = x;
      const catcherWidth = 40;
      miniCatcherEl.style.left = (catcherX - catcherWidth / 2) + 'px';
    }

    // ãŠä¸–è©±å†…å®¹ â†’ ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ç¨®é¡
    function chooseMiniGameType(taskText) {
      const t = taskText;
      if (/(ãã‚ãˆ|ãã‚ãˆã‚‹|æƒãˆ|ä¸¦ã¹|ä¸¦ã³æ›¿ãˆ|é †ã«|ãƒ©ã‚¤ãƒ³)/.test(t)) {
        return 'arrange';
      }
      if (/(ã»ã“ã‚Š|ãƒ›ã‚³ãƒª|åŸƒ|ã‚´ãƒŸ|ã”ã¿|æ°´ã—ã¶ã|æ±šã‚Œ|æ±šã‚Œå…·åˆ)/.test(t)) {
        return 'clean';
      }
      return 'fall';
    }

    function openMiniForCurrentTask() {
      if (currentIndex >= TOTAL_TASKS) return;

      const taskNo = currentIndex + 1;
      const taskText = tasks[currentIndex] || "";
      const label = taskText.split('ï¼ˆ')[0];

      miniGameType = chooseMiniGameType(taskText);
      currentMiniKind = 'normal';

      if (miniGameType === 'fall') {
        if (taskNo % 18 === 0 && taskNo % 27 === 0) {
          currentMiniKind = Math.random() < 0.5 ? 'poop' : 'water';
        } else if (taskNo % 18 === 0) {
          currentMiniKind = 'poop';
        } else if (taskNo % 27 === 0) {
          currentMiniKind = 'water';
        }

        if (currentMiniKind === 'poop') {
          miniCaptionEl.textContent =
            `ã€Œ${label}ã€ã‚’ã€ãªãœã‹ğŸ’©ãŒè½ã¡ã¦ãã‚‹ã‚²ãƒ¼ãƒ ã§è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚ï¼ˆæœ¬å½“ã«æ„å‘³ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰`;
        } else if (currentMiniKind === 'water') {
          miniCaptionEl.textContent =
            `ã€Œ${label}ã€ã‚’ã€ãªãœã‹ğŸ’§ãŒè½ã¡ã¦ãã‚‹ã‚²ãƒ¼ãƒ ã§è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚ï¼ˆæœ¬å½“ã«æ„å‘³ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰`;
        } else {
          miniCaptionEl.textContent =
            `ã€Œ${label}ã€ã‚’ã€ä¸¸ã„ã‚‚ã®ã‚’æ‹¾ã†è½ã¡ã‚‚ã®ã‚²ãƒ¼ãƒ ã§ã–ã£ãã‚Šå†ç¾ã—ã¦ã„ã¾ã™ã€‚ï¼ˆã‚ã¾ã‚Šé–¢ä¿‚ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰`;
        }
      } else if (miniGameType === 'arrange') {
        miniCaptionEl.textContent =
          `ã€Œ${label}ã€ã‚’ã€ãƒãƒ©ãƒãƒ©ã®å››è§’ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ä¸€åˆ—ã«ãã‚ãˆã‚‹ã‚²ãƒ¼ãƒ ã§å†ç¾ã—ã¦ã„ã¾ã™ã€‚ï¼ˆãã‚ãˆã¦ã‚‚ç‰¹ã«ä½•ã‚‚èµ·ãã¾ã›ã‚“ï¼‰`;
      } else if (miniGameType === 'clean') {
        miniCaptionEl.textContent =
          `ã€Œ${label}ã€ã‚’ã€æ±šã‚Œã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚‚ãœã‚“ãœã‚“æ¶ˆãˆãªã„æƒé™¤ã‚²ãƒ¼ãƒ ã§å†ç¾ã—ã¦ã„ã¾ã™ã€‚ï¼ˆã“ã™ã£ã¦ã‚‚ä¸–ç•Œã¯ã‚ã¾ã‚Šå¤‰ã‚ã‚Šã¾ã›ã‚“ï¼‰`;
      }

      miniModalEl.style.display = 'flex';
      resetMiniGameView();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆ
    miniAreaEl.addEventListener('mousemove', onMiniPointerMove);
    miniAreaEl.addEventListener('touchmove', e => {
      onMiniPointerMove(e);
      e.preventDefault();
    }, { passive: false });

    miniStartBtn.addEventListener('click', startMiniGame);

    miniOkBtn.addEventListener('click', () => {
      miniPlayedForThisTask = true;
      miniModalEl.style.display = 'none';
      setButtonsEnabled(true);
      openMiniBtn.textContent = 'ã‚‚ã†ä¸€åº¦ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ã‚’ã™ã‚‹';
      logMessageEl.textContent =
        'ãªã‚“ã¨ãªããŠä¸–è©±ã—ã¦ã¿ã¾ã—ãŸã­ã€‚ä»Šã®æ„Ÿè¦šã§ã€ã“ã®ãŠä¸–è©±ã®ã¤ã¾ã‚‰ãªã•ã‚’ã‚¸ãƒ£ãƒƒã‚¸ã—ã¦ã¿ã¦ãã ã•ã„ã€‚';
    });

    ratingButtonsEl.querySelectorAll('.btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const score = Number(btn.dataset.score);
        handleRating(score);
      });
    });

    openMiniBtn.addEventListener('click', openMiniForCurrentTask);

    // åˆæœŸåŒ–
    function initGame() {
      currentIndex = 0;
      ratings.length = 0;
      miniPlayedForThisTask = false;
      resultBoxEl.style.display = 'none';
      resultBoxEl.innerHTML = '';
      setButtonsEnabled(false);
      updateCharacter();
      updateTask();
      updateBoredomMeter();
      logMessageEl.textContent = '';
    }

    function startGame() {
      startScreenEl.style.display = 'none';
      gameContainerEl.style.display = 'block';
      initGame();
    }

    startButtonEl.addEventListener('click', startGame);

    // Element SDK
    const defaultConfig = {
      main_title: "ğŸ¥š ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã‚²ãƒ¼ãƒ ",
      subtitle: "å ±ã‚ã‚Œãªã„ãŠä¸–è©±ã‚’100å€‹ã“ãªã™ã¨ã€å¤‰ãªã‚­ãƒ£ãƒ©ãŒç”Ÿã¾ã‚Œã¾ã™ã€‚"
    };

    async function onConfigChange(config) {
      document.getElementById('mainTitle').textContent =
        config.main_title || defaultConfig.main_title;
      document.getElementById('subtitle').textContent =
        config.subtitle || defaultConfig.subtitle;
      document.getElementById('startMainTitle').textContent =
        config.main_title || defaultConfig.main_title;
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["main_title", config.main_title || defaultConfig.main_title],
        ["subtitle",   config.subtitle   || defaultConfig.subtitle]
      ]);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
  </script>
</body>
</html>
